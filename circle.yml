machine:
  pre:
    - echo 'DOCKER_OPTS="-s btrfs -e lxc -D --userland-proxy=false"' | sudo tee -a /etc/default/docker
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.2-circleci-cp-workaround'
    - sudo chmod 0755 /usr/bin/docker
  node:
    version: 4.1.0
  services:
    - docker
dependencies:
  override:
    - mkdir -p ./bin
    - pip install fabric==1.8.1
    - pip install pycrypto
    - make hub-deps
test:
  override:
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_AUTH
    - docker build -f dockerfiles/milky-way-no-bin -t milky-no-bin ./dockerfiles
    - make dev
    - make dev-tag
    - make stage
    - mkdir .stage/
    - make copy-stage
    - docker run -d --name milky milky-no-bin sleep 15m
    - cd .stage/.build-prod && docker cp milky:/opt/hub/modules.tar . && docker build -t bagel/hub-stage .
    - make prod
    - make base-prod-tag
    - make copy-prod
    - docker run -d --name milky-2 milky-no-bin sleep 15m
    - cd .build-prod && docker cp milky-2:/opt/hub/modules.tar . && docker build -t bagel/hub-prod .
    - docker run -de ENV=production -p 3000:3000 --name hub-prod-tester bagel/hub-prod
    - sleep 60s
    - curl $(docker inspect --format '{{ .NetworkSettings.IPAddress }}' hub-prod-tester):3000
deployment:
  autodeploy:
    branch: [master, autodeploy]
    owner: docker
    commands:
      - docker push bagel/hub-prod
      - docker push bagel/hub-stage
      - chmod 400 ~/.ssh/id_console-demo
      - fab -H root@console-demo.docker.com -i ~/.ssh/id_console-demo start_project:email=$DOCKER_EMAIL,user=$DOCKER_USER,auth=$DOCKER_AUTH,beta_password=$BETA_PASSWORD,sha=latest,new_relic_key=$NEW_RELIC_KEY,new_relic_app_name=$NEW_RELIC_APP_NAME
