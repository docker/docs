{{- /*
  This template recursively renders the sidebar navigation, grouping pages by `Params.sidebar.groups`.
  Highlights:
  - Supports hierarchical navigation with collapsible sections (`renderList` template).
  - Dynamically applies current page highlighting and expanded states.
  - Handles external links via `Params.sidebar.goto` in `renderSingle`.
  - Requires `Params.sitemap` and `Params.sidebar` for filtering and behavior.
  */
-}}
<!-- section tree -->
<nav class="navbar-font flex flex-col">
  <div class="block py-4 text-gray-200 md:hidden dark:text-gray-200">
    This section
  </div>
  <ul>
    {{ template "renderChildren" .FirstSection }}
  </ul>
</nav>

{{ define "renderChildren" }}
  {{- $pages := where .Pages "Params.sitemap" "ne" "false" }}
  {{- if .Params.sidebar.reverse }}
    {{ $pages = .Pages.Reverse }}
  {{- end }}
  {{- $ungrouped := where $pages "Params.sidebar.group" "==" nil }}
  {{- range $ungrouped }}
    {{- if .IsSection }}
      {{- template "renderList" . }}
    {{- else }}
      {{- template "renderSingle" . }}
    {{- end }}
  {{- end }}
  {{- range .Params.sidebar.groups }}
    <!--  Main titles -->
    <li class="navbar-group-font-title mt-2 px-2 py-2 pt-5 pb-2">
      {{ . }}
    </li>
    {{- range where $pages "Params.sidebar.group" . }}
      {{- if .IsSection }}
        {{- template "renderList" . }}
      {{- else }}
        {{- template "renderSingle" . }}
      {{- end }}
    {{- end }}
  {{- end }}
{{ end }}

{{/* Recursive template for sidebar items */}}
{{ define "renderList" }}
  {{ $isCurrent := eq page . }}
  {{ $expanded := or $isCurrent (page.IsDescendant .) }}
  <li x-data="{ expanded: {{ $expanded }} }">
    <div
      class="justify-between{{ if $isCurrent }}
        bg-gray-100 dark:bg-gray-900
      {{ end }} flex w-full items-center rounded-sm px-4"
    >
      <div class="w-full truncate py-1">
        {{- if .Permalink }}
          {{/* If the link is not empty, use it */}}
          <a
            {{ if $isCurrent }}
              aria-current="page" id="sidebar-current-page"
            {{ end }}
            class="hover:text-blue block select-none hover:dark:text-blue-400"
            href="{{ .Permalink }}"
          >
            {{ template "renderTitle" . }}
          </a>
        {{- else }}
          {{/* Otherwise, just expand the section */}}
          <button
            @click="expanded = !expanded"
            class="hover:text-blue w-full text-left select-none hover:dark:text-blue-400"
          >
            {{ template "renderTitle" . }}
          </button>
        {{- end }}
      </div>
      <button
        @click="expanded = !expanded"
        class="rounded-sm hover:bg-gray-300 hover:dark:bg-gray-300"
      >
        <span
          :class="{ 'hidden' : expanded }"
          class="icon-svg {{ if $expanded }}hidden{{ end }}"
        >
          {{ partialCached "icon" "arrow_drop_down" "arrow_drop_down" }}
        </span>
        <span
          :class="{ 'hidden' : !expanded }"
          class="icon-svg {{ if not $expanded }}hidden{{ end }}"
        >
          {{ partialCached "icon" "arrow_drop_up" "arrow_drop_up" }}
        </span>
      </button>
    </div>
    <ul
      :class="{ 'hidden' : !expanded }"
      class="{{ if not $expanded }}hidden{{ end }}ml-3"
    >
      {{ template "renderChildren" . }}
    </ul>
  </li>
{{ end }}

{{ define "renderSingle" }}
  {{- if .Params.sidebar.goto }}
    <li class="hover:text-blue px-4 hover:dark:text-blue-400">
      <a
        class="block w-full truncate py-2"
        href="{{ .Params.sidebar.goto }}"
        title="{{ .LinkTitle }}"
      >
        {{ template "renderTitle" . }}
      </a>
    </li>
  {{- else }}
    {{ $isCurrent := eq page . }}
    <li
      class="hover:text-blue {{ if $isCurrent }}
        bg-gray-100 dark:bg-gray-900
      {{ end }} rounded-sm px-4 hover:dark:text-blue-400"
    >
      <a
        {{ if $isCurrent }}
          aria-current="page" id="sidebar-current-page"
        {{ end }}
        class="block w-full truncate py-2"
        href="{{ .Permalink }}"
        title="{{ .LinkTitle }}"
      >
        {{ template "renderTitle" . }}
      </a>
    </li>
  {{- end }}
{{ end }}

{{ define "renderTitle" }}
  {{ .LinkTitle }}
  {{- with .Params.sidebar.badge }}
    <span
      >{{- partial "components/badge.html" (dict "color" .color "content" .text) }}</span
    >
  {{- end }}
{{ end }}
