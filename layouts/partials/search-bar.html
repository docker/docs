<div id="search-bar" class="h-full relative flex items-center overflow-visible">
  <button
    type="button"
    aria-label="Search"
    class="cursor-pointer flex items-center gap-2 p-2 rounded-lg bg-blue-700 border border-blue-500 text-white transition-colors focus:outline-none focus:ring focus:ring-blue-400 hover:bg-blue-800 hover:border-blue-400"
    id="search-modal-trigger"
  >
    <span class="icon-svg">
      {{ partialCached "icon" "search" "search" }}
    </span>
    <span class="hidden px-1 lg:inline">Search</span>
  </button>
</div>

<script type="module">
  // Configure Pagefind before any components connect to DOM
  await import('/pagefind/pagefind-component-ui.js');
  const { configureInstance, getInstanceManager } = window.PagefindComponents;

  configureInstance('default', {
    bundlePath: '/pagefind/',
    ranking: {
      termFrequency: 0.0,
      termSimilarity: 2.0,
      pageLength: 0.0,
      termSaturation: 1.0
    }
  });

  // Create modal after config is set
  document.body.insertAdjacentHTML('beforeend', `
    <pagefind-modal id="search-modal" reset-on-close>
      <pagefind-modal-header>
        <pagefind-input placeholder="Search documentationâ€¦"></pagefind-input>
      </pagefind-modal-header>
      <pagefind-modal-body>
        <p id="search-placeholder" class="text-center text-gray-500 dark:text-gray-400 py-8">
          Start typing to search the documentation
        </p>
        <pagefind-summary></pagefind-summary>
        <pagefind-results></pagefind-results>
      </pagefind-modal-body>
    </pagefind-modal>
  `);

  const modal = document.getElementById('search-modal');
  const placeholder = document.getElementById('search-placeholder');

  // Custom result template
  modal.querySelector('pagefind-results').resultTemplate = (result) => {
    const li = document.createElement('li');
    li.className = 'py-3 border-b border-gray-200 dark:border-gray-700 last:border-b-0';

    const title = document.createElement('p');
    title.className = 'font-medium';

    const link = document.createElement('a');
    link.className = 'text-blue-600 dark:text-blue-400 hover:underline';
    link.href = result.meta.url || result.url;
    link.textContent = result.meta.title;
    title.appendChild(link);
    li.appendChild(title);

    if (result.excerpt) {
      const excerpt = document.createElement('p');
      excerpt.className = 'text-gray-600 dark:text-gray-400 mt-1 text-sm';
      excerpt.innerHTML = result.excerpt;
      li.appendChild(excerpt);
    }

    if (result.sub_results?.length) {
      const ul = document.createElement('ul');
      ul.className = 'mt-3 ml-4 flex flex-wrap gap-2';
      for (const sub of result.sub_results) {
        const subLi = document.createElement('li');
        subLi.className = 'text-sm';
        const subLink = document.createElement('a');
        subLink.className = 'text-blue-600 dark:text-blue-400 hover:underline';
        subLink.href = sub.url;
        subLink.textContent = sub.title;
        subLi.appendChild(subLink);
        ul.appendChild(subLi);
      }
      li.appendChild(ul);
    }

    return li;
  };

  // Show/hide placeholder based on search state
  const instance = getInstanceManager().getInstance('default');
  instance.on('search', (term) => {
    placeholder.hidden = !!term;
  });
  instance.on('results', () => {
    placeholder.hidden = !!instance.searchTerm;
  });

  // Open modal
  const openModal = () => modal.open?.();
  document.getElementById('search-modal-trigger').addEventListener('click', openModal);
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openModal();
    }
  });
</script>
